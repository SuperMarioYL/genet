# Backend configuration
backend:
  image: genet-backend:latest
  imagePullPolicy: IfNotPresent
  replicas: 2

  # Backend configuration (injected via ConfigMap)
  config:
    podLimitPerUser: 5
    gpuLimitPerUser: 8

    gpu:
      availableTypes:
        - name: "NVIDIA A100"
          resourceName: "nvidia.com/gpu"
          nodeSelector:
            gpu-type: "a100"
        - name: "NVIDIA V100"
          resourceName: "nvidia.com/gpu"
          nodeSelector:
            gpu-type: "v100"
        - name: "NVIDIA T4"
          resourceName: "nvidia.com/gpu"
          nodeSelector:
            gpu-type: "t4"

      presetImages:
        - name: "CUDA 12.0"
          image: "nvidia/cuda:12.0.0-base-ubuntu22.04"
          description: "NVIDIA CUDA 12.0 基础镜像"
        - name: "PyTorch 2.0"
          image: "pytorch/pytorch:2.0.1-cuda11.7-cudnn8-runtime"
          description: "PyTorch 2.0 with CUDA 11.7"
        - name: "TensorFlow 2.13"
          image: "tensorflow/tensorflow:2.13.0-gpu"
          description: "TensorFlow 2.13 GPU 版本"

    ui:
      defaultTTLHours: 4
      minTTLHours: 1
      maxTTLHours: 24
      enableJupyter: false
      enableCustomImage: true

    lifecycle:
      autoDeleteTime: "23:00"
      timezone: "Asia/Shanghai"
      warningThresholdHours: 1

    storage:
      # 用户 workspace PVC 配置
      storageClass: "standard" # 根据集群调整
      size: "50Gi"

      # 注意：extraVolumes 已废弃，请使用下面的 pod.extraVolumes（K8s 原生格式）
      # extraVolumes: []

    # Pod 配置（Kubernetes 原生格式）
    # 使用 K8s 标准 YAML，直接参考 K8s 官方文档配置
    # 文档: https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#podspec-v1-core
    pod:
      # 使用主机网络（SSH 端口直接暴露在主机上）
      hostNetwork: true

      # DNS 策略（K8s 原生格式）
      # 可选值: ClusterFirst, ClusterFirstWithHostNet, Default, None
      # 当 hostNetwork=true 时，推荐使用 ClusterFirstWithHostNet（默认值）
      dnsPolicy: ClusterFirstWithHostNet

      # 自定义 DNS 配置（可选，当 dnsPolicy 为 None 时必须配置）
      # dnsConfig:
      #   nameservers:
      #     - 8.8.8.8
      #     - 8.8.4.4
      #   searches:
      #     - cluster.local
      #   options:
      #     - name: ndots
      #       value: "5"

      # 资源配置（K8s 原生格式）
      resources:
        requests:
          cpu: "2"
          memory: "4Gi"
        limits:
          cpu: "8"
          memory: "16Gi"

      # 安全上下文（K8s 原生格式）
      securityContext:
        capabilities:
          add:
            - SYS_ADMIN

      # 节点选择器（标签匹配，可选）
      # nodeSelector:
      #   disk: ssd
      #   env: production

      # 亲和性调度（高级规则，K8s 原生格式，可选）
      # 文档: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#affinity-and-anti-affinity
      # affinity:
      #   nodeAffinity:
      #     # 必须满足的规则（硬约束）
      #     requiredDuringSchedulingIgnoredDuringExecution:
      #       nodeSelectorTerms:
      #         - matchExpressions:
      #             - key: nvidia.com/gpu
      #               operator: Exists
      #     # 优先满足的规则（软约束）
      #     preferredDuringSchedulingIgnoredDuringExecution:
      #       - weight: 80  # 权重 1-100
      #         preference:
      #           matchExpressions:
      #             - key: disk
      #               operator: In
      #               values:
      #                 - ssd
      #                 - nvme
      #       - weight: 50
      #         preference:
      #           matchExpressions:
      #             - key: topology.kubernetes.io/region
      #               operator: In
      #               values:
      #                 - us-west-1
      #                 - us-west-2

      # 额外的存储配置（K8s 原生格式，可选）
      # 注意：用户的 workspace PVC 会自动添加，这里配置额外的存储卷
      # 文档: https://kubernetes.io/docs/concepts/storage/volumes/
      # extraVolumes: []
      # extraVolumeMounts: []
      # 示例配置：
      # extraVolumes:
      #   # PVC 存储（共享数据集）
      #   - name: datasets
      #     persistentVolumeClaim:
      #       claimName: shared-datasets
      #       readOnly: true
      #   # HostPath 存储（本地缓存）
      #   - name: cache
      #     hostPath:
      #       path: /mnt/cache
      #       type: DirectoryOrCreate
      #   # NFS 存储（网络存储）
      #   - name: models
      #     nfs:
      #       server: nfs.example.com
      #       path: /exports/models
      #       readOnly: true
      #   # ConfigMap（配置文件）
      #   - name: config
      #     configMap:
      #       name: my-config
      #   # Secret（密钥）
      #   - name: credentials
      #     secret:
      #       secretName: my-secret
      # extraVolumeMounts:
      #   - name: datasets
      #     mountPath: /data/datasets
      #     readOnly: true
      #   - name: cache
      #     mountPath: /data/cache
      #   - name: models
      #     mountPath: /data/models
      #     readOnly: true
      #   - name: config
      #     mountPath: /etc/config
      #     readOnly: true
      #   - name: credentials
      #     mountPath: /etc/credentials
      #     readOnly: true

      # 容器启动脚本模板（必需）
      # 可用变量: {{.SSHPort}}, {{.Password}}, {{.ProxyScript}}
      startupScript: |
        #!/bin/bash
        set -e

        echo "=== Starting Genet Pod ==="

        # 创建必要目录
        mkdir -p /run/sshd /workspace

        # 持久化 VS Code Server 目录（避免每次连接重新下载）
        # VS Code Server 会保存在 /workspace/.vscode-server，Pod 重建后仍然可用
        mkdir -p /workspace/.vscode-server
        rm -rf /root/.vscode-server 2>/dev/null || true
        ln -sf /workspace/.vscode-server /root/.vscode-server
        echo "VS Code Server directory linked to /workspace/.vscode-server"

        {{.ProxyScript}}

        # 设置 root 密码
        echo "root:{{.Password}}" | chpasswd

        # 生成 SSH host keys（如果不存在）
        ssh-keygen -A 2>/dev/null || true

        # 创建 sshd 配置
        cat > /etc/ssh/sshd_config.genet << 'SSHEOF'
        Port {{.SSHPort}}
        PermitRootLogin yes
        PasswordAuthentication yes
        PubkeyAuthentication yes
        ChallengeResponseAuthentication no
        UsePAM yes
        Subsystem sftp /usr/lib/ssh/sftp-server
        HostKey /etc/ssh/ssh_host_rsa_key
        HostKey /etc/ssh/ssh_host_ecdsa_key
        HostKey /etc/ssh/ssh_host_ed25519_key
        SSHEOF

        # 启动 SSH 服务
        echo "Starting sshd on port {{.SSHPort}}..."
        /usr/sbin/sshd -f /etc/ssh/sshd_config.genet -D &
        SSHD_PID=$!
        sleep 2

        # 检查 sshd 是否启动成功
        if kill -0 $SSHD_PID 2>/dev/null; then
            echo "sshd started successfully (PID: $SSHD_PID)"
        else
            echo "WARNING: sshd may have failed to start"
        fi

        # 显示 GPU 信息（如果有）
        if command -v nvidia-smi &> /dev/null; then
            echo "===== GPU Information ====="
            nvidia-smi || true
        else
            echo "===== CPU Only Mode ====="
        fi

        # 显示连接信息
        echo ""
        echo "============================================"
        echo "Pod is ready!"
        echo "SSH Port: {{.SSHPort}}"
        echo "Connect: ssh root@<node-ip> -p {{.SSHPort}}"
        echo "Password: {{.Password}}"
        echo "============================================"

        # 保持容器运行
        tail -f /dev/null

    oauth:
      enabled: false
      # 认证模式: "oidc" 或 "oauth"
      # - oidc: 自动发现端点（需配置 providerURL）
      # - oauth: 手动配置端点（需配置 authorizationEndpoint, tokenEndpoint）
      mode: "oidc"

      # OIDC 模式配置
      providerURL: "" # OIDC Issuer URL，如: https://auth.example.com

      # OAuth 模式配置（mode 为 "oauth" 时使用）
      authorizationEndpoint: "" # OAuth 授权端点
      tokenEndpoint: "" # OAuth Token 端点
      userinfoEndpoint: "" # 用户信息端点（可选）

      # 用户信息获取方式: "endpoint", "token", "both"
      # - endpoint: 从 userinfo API 获取
      # - token: 从 access_token/id_token JWT 解析
      # - both: 优先从 token 解析，失败则调用 endpoint
      userinfoSource: "endpoint"

      # userinfo API 的请求方式: "get" 或 "post"
      # - get:  GET 请求 + Authorization: Bearer {token} （标准 OIDC）
      # - post: POST JSON 请求，body 包含 {client_id, access_token, scope}
      userinfoMethod: "get"

      # 用户信息字段映射（适用于 token 解析和 endpoint 响应）
      tokenUsernameClaim: "preferred_username" # 用户名字段
      tokenEmailClaim: "email" # 邮箱字段

      # 公共配置
      clientID: ""
      clientSecret: ""
      redirectURL: "" # 如: https://genet.example.com/api/auth/callback
      frontendURL: "" # 如: https://genet.example.com
      scopes:
        - "openid"
        - "profile"
        - "email"
      jwtSecret: "" # 生产环境必须设置强密钥
      cookieDomain: ""
      cookieSecure: true # 生产环境使用 HTTPS

    # 代理配置（会注入到用户 Pod 的环境变量和 ~/.bashrc 中）
    proxy:
      httpProxy: "" # HTTP 代理地址，如: http://proxy.example.com:8080
      httpsProxy: "" # HTTPS 代理地址
      noProxy: "localhost,127.0.0.1,.cluster.local,10.0.0.0/8" # 不使用代理的地址

    # 镜像仓库配置（用于镜像保存/commit 功能）
    registry:
      url: "" # 镜像仓库地址，如: registry.example.com
      username: "" # 仓库用户名
      password: "" # 仓库密码

    # 系统依赖镜像配置
    images:
      nerdctl: "ghcr.io/containerd/nerdctl:v1.7.0" # nerdctl 镜像，用于 commit 操作

    # Kubernetes 客户端配置
    kubernetes:
      disableProxy: true # 禁用 HTTP/HTTPS 代理（解决 Windows 代理冲突）
      timeout: 30 # API 请求超时时间（秒）

# Frontend configuration
frontend:
  image: genet-frontend:latest
  imagePullPolicy: IfNotPresent
  replicas: 2

# CronJob configuration (lifecycle controller)
cronjob:
  schedule: "*/1 * * * *" # Every minute
  image: genet-backend:latest

# Ingress configuration
ingress:
  enabled: true
  className: "nginx"
  host: "genet.example.com"
  tls:
    enabled: false
    secretName: ""

# Service configuration
service:
  backend:
    type: ClusterIP
    port: 8080
  frontend:
    type: ClusterIP
    port: 80
